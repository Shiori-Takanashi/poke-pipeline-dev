# Architecture

poke-pipelineの設計思想とアーキテクチャについて説明します。

## 設計思想

### 1. モジュール分離
- **単一責任原則**: 各モジュールは明確な責任を持つ
- **疎結合**: モジュール間の依存関係を最小限に抑制
- **再利用性**: 汎用的なコンポーネントの提供

### 2. 非同期処理
- **高速データ取得**: aiohttpによる並行リクエスト
- **リソース効率**: セマフォによる同時実行数制御
- **エラー処理**: リトライ機能とタイムアウト管理

### 3. 設定の集中管理
- **設定ファイル**: `config/` ディレクトリに集約
- **環境分離**: 開発・テスト・本番環境の切り替え
- **型安全**: 型ヒントによる設定値の検証

## システム構成

```
┌─────────────────────────────────────────────────────────────┐
│                        CLI Layer                            │
├─────────────────────────────────────────────────────────────┤
│                     Service Layer                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Fetch     │  │  Extract    │  │   Check     │         │
│  │   Module    │  │  Module     │  │   Module    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                    Utility Layer                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   I/O       │  │  Directory  │  │  Language   │         │
│  │   Utils     │  │   Utils     │  │   Utils     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                   Configuration Layer                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Paths     │  │  Constants  │  │   Targets   │         │
│  │   Config    │  │   Config    │  │   Config    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                     Data Layer                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │    JSON     │  │  Database   │  │    Logs     │         │
│  │   Files     │  │   SQLite    │  │   Files     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネント詳細

### CLI Layer
- **cli/demo.py**: デモンストレーション用CLI
- **cli/__init__.py**: CLIモジュール初期化

### Service Layer

#### Fetch Module
- **目的**: PokéAPIからのデータ取得
- **特徴**: 非同期処理、リトライ機能、レート制限対応
- **主要クラス**: `ApiClient`, `DataFetcher`

#### Extract Module
- **目的**: JSONデータの変換・整形
- **特徴**: 言語フィルタリング、構造最適化
- **主要クラス**: `JsonTransformer`

#### Check Module
- **目的**: データ品質チェック
- **特徴**: バリデーション、整合性確認
- **主要クラス**: `DataValidator`

### Utility Layer
- **util/io_json.py**: JSON I/O操作
- **util/directory.py**: ディレクトリ操作
- **util/language.py**: 言語関連処理
- **util/process_idx.py**: インデックス処理

### Configuration Layer
- **config/constant.py**: 定数定義
- **config/target.py**: 対象エンドポイント
- **config/dirpath.py**: ディレクトリパス
- **config/filepath.py**: ファイルパス

### Data Layer
- **JSON Files**: 生データとし処理済みデータ
- **SQLite Database**: 構造化データストレージ
- **Log Files**: アプリケーションログ

## データフロー

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   PokéAPI   │───▶│    Fetch    │───▶│   Extract   │───▶│   Storage   │
│   (HTTP)    │    │   Module    │    │   Module    │    │  (JSON/DB)  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                           │                   │
                           ▼                   ▼
                   ┌─────────────┐    ┌─────────────┐
                   │    Logs     │    │    Check    │
                   │   Module    │    │   Module    │
                   └─────────────┘    └─────────────┘
```

### 処理フロー詳細

1. **API呼び出し**: 非同期HTTPクライアントでPokéAPIを呼び出し
2. **データ取得**: JSON形式でレスポンスを受信
3. **エラー処理**: 失敗時のリトライとログ記録
4. **データ変換**: JsonTransformerでデータ整形
5. **品質チェック**: データの妥当性確認
6. **データ保存**: ファイルシステムとデータベースに保存
7. **ログ記録**: 処理結果とエラーのログ出力

## 非同期処理アーキテクチャ

### セマフォによる並行制御

```python
# 最大50並行でリクエスト制御
semaphore = asyncio.Semaphore(50)

async def fetch_with_semaphore(url):
    async with semaphore:
        return await fetch_data(url)
```

### エラーハンドリング

```python
# リトライ機能付きリクエスト
async def fetch_with_retry(url, max_retries=3):
    for attempt in range(max_retries):
        try:
            return await fetch_data(url)
        except Exception as e:
            if attempt == max_retries - 1:
                raise
            await asyncio.sleep(2 ** attempt)
```

## 拡張性とメンテナンス性

### 新しいエンドポイントの追加

1. `config/target.py` にエンドポイント追加
2. 必要に応じて変換ルールを `JsonTransformer` に追加
3. テストケースの作成

### 新しい変換処理の追加

1. `JsonTransformer` クラスに新しいメソッド追加
2. `all_transform` メソッドに処理を統合
3. 単体テストの実装

### 新しいデータソースの追加

1. `fetch/` モジュールに新しいクライアント実装
2. 共通インターフェースの継承
3. 設定ファイルの更新

## パフォーマンス考慮事項

### メモリ使用量
- ストリーミング処理でメモリ使用量を制御
- 大きなデータセットは分割処理

### ネットワーク効率
- HTTP/2対応による効率的な通信
- 適切なタイムアウト設定

### I/O最適化
- 非同期ファイル操作の活用
- バッチ処理による効率化

## セキュリティ

### API キー管理
- 環境変数による秘匿情報管理
- 設定ファイルからの除外

### 入力値検証
- pydanticによるデータバリデーション
- SQLインジェクション対策

## 監視とログ

### ログレベル
- **DEBUG**: 詳細な実行情報
- **INFO**: 一般的な実行状況
- **WARNING**: 注意が必要な状況
- **ERROR**: エラーとスタックトレース

### メトリクス
- API呼び出し回数と成功率
- 処理時間とスループット
- エラー発生率と種類

## 今後の拡張予定

- GraphQL APIクライアント対応
- PostgreSQL対応
- Kubernetes環境での実行
- リアルタイム処理機能
- Web UIの提供
